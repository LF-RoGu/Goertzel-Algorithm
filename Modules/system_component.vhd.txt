library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity system is
    generic (
        N : integer;
        freq_sample : integer
    );
    port (
        clk : in std_logic;
        rst : in std_logic;
        input : in unsigned(11 downto 0);
        magnitude : out signed(19 downto 0);
        real_out : out signed(19 downto 0);
        imaginary : out signed(19 downto 0)
    );
end entity system;

architecture Behavioral of system is

    signal coeff : real;
    signal sine, cosine : real;
    signal scale : real;
    signal q0, q1, q2 : real;

    -- Subcomponent declarations
    component goertzel_init is
        generic (
            N : integer;
            freq_sample : integer
        );
        port (
            clk : in std_logic;
            rst : in std_logic;
            coeff : out real;
            sine : out real;
            cosine : out real;
            scale : out real
        );
    end component goertzel_init;

    component goertzel_final is
        generic (
            N : integer
        );
        port (
            clk : in std_logic;
            rst : in std_logic;
            sample : in unsigned(11 downto 0);
            coeff : in real;
            q0 : out real;
            q1 : out real;
            q2 : out real
        );
    end component goertzel_final;

    component result is
        port (
            clk : in std_logic;
            rst : in std_logic;
            q1 : in real;
            q2 : in real;
            sine : in real;
            cosine : in real;
            scale : in real;
            magnitude : out signed(19 downto 0);
            real_out : out signed(19 downto 0);
            imaginary : out signed(19 downto 0)
        );
    end component result;

begin

    -- Instantiation of initializer
    u_initializer : goertzel_init
        generic map (
            N => N,
            freq_sample => freq_sample
        )
        port map (
            clk => clk,
            rst => rst,
            coeff => coeff,
            sine => sine,
            cosine => cosine,
            scale => scale
        );

    -- Instantiation of goertzel
    u_goertzel : goertzel_final
        generic map (
            N => N
        )
        port map (
            clk => clk,
            rst => rst,
            sample => input,
            coeff => coeff,
            q0 => q0,
            q1 => q1,
            q2 => q2
        );

    -- Instantiation of result
    u_result : result
        port map (
            clk => clk,
            rst => rst,
            q1 => q1,
            q2 => q2,
            sine => sine,
            cosine => cosine,
            scale => scale,
            magnitude => magnitude,
            real_out => real_out,
            imaginary => imaginary
        );

end architecture Behavioral;
